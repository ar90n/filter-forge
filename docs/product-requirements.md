# プロダクト要求定義書 (PRD)

## 1. プロダクト概要

### 1.1 プロダクト名

**FilterForge** - アナログフィルタ回路設計Webアプリケーション

### 1.2 ビジョン

回路エンジニアが、仕様を入力するだけで最適なアナログフィルタ回路を即座に設計でき、特性確認からBOM出力まで一気通貫で行えるWebツール。

### 1.3 背景と課題

- フィルタ回路の設計には伝達関数の計算、近似関数の選択、部品値の算出など多くの手順が必要
- 既存のツールはデスクトップアプリが多く、インストール不要のWebツールが少ない
- 設計結果から実装に必要な部品リスト(BOM)を手動で作成する手間がかかる

### 1.4 ゴール

- ブラウザだけで完結するフィルタ回路設計環境を提供する
- 設計 → 特性確認 → BOM出力の一連のワークフローをシームレスに繋げる
- GitHub Pagesでホスト可能な静的SPAとして提供する

## 2. 対象ユーザー

### 2.1 プライマリユーザー

**回路エンジニア**
- アナログ回路の設計経験がある
- フィルタの基本概念（カットオフ周波数、減衰量、フィルタ次数など）を理解している
- 日常的にフィルタ回路を設計する業務がある

### 2.2 セカンダリユーザー

**電子工学の学生・学習者**
- フィルタ回路の理論を学んでおり、実際の設計を試してみたい
- 各パラメータが特性にどう影響するかを視覚的に確認したい

## 3. スコープ

### 3.1 MVP（初期リリース）スコープ

#### フィルタ回路タイプ
- **パッシブフィルタのみ**（LC フィルタ、RC フィルタ）
- オペアンプを使ったアクティブフィルタは将来対応

#### フィルタ種別
| 種別 | 略称 | 説明 |
|------|------|------|
| ローパスフィルタ | LPF | 低周波数成分を通過させる |
| ハイパスフィルタ | HPF | 高周波数成分を通過させる |
| バンドパスフィルタ | BPF | 特定の周波数帯域を通過させる |
| バンドエリミネートフィルタ | BEF | 特定の周波数帯域を除去する |
| オールパスフィルタ | APF | 振幅特性は変えず位相のみを変化させる |

#### 近似関数（応答タイプ）
| 近似関数 | 特徴 |
|----------|------|
| Butterworth | 最大平坦振幅特性。通過帯域にリップルなし |
| Chebyshev Type I | 通過帯域にリップルあり。急峻な遮断特性 |
| Chebyshev Type II | 阻止帯域にリップルあり。通過帯域は平坦 |
| Bessel | 最大平坦群遅延特性。位相特性が良好 |
| Elliptic (Cauer) | 通過・阻止帯域の両方にリップルあり。最も急峻な遮断 |

### 3.2 将来スコープ（MVP外）

- アクティブフィルタ（Sallen-Key、Multiple Feedback など）
- デジタルフィルタ（FIR/IIR）
- フィルタのカスケード接続
- 設計結果のエクスポート（PDF、SPICEネットリスト）
- E系列（E12/E24/E96）に基づく部品値の丸め処理
- 標準部品値を使った場合の特性シミュレーション

## 4. 機能要件

### FR-1: フィルタ仕様の入力

**概要**: ユーザーが設計したいフィルタの仕様を入力する

**入力パラメータ**:
- フィルタ種別（LPF / HPF / BPF / BEF / APF）
- 近似関数（Butterworth / Chebyshev I / Chebyshev II / Bessel / Elliptic）
  - APF の場合は近似関数の選択不要（位相シフト量で指定）
- カットオフ周波数（Hz / kHz / MHz）
  - BPF/BEF の場合は中心周波数と帯域幅、または下限・上限周波数
  - APF の場合は位相シフトの中心周波数
- フィルタ次数（1〜10次）
- 通過帯域リップル（Chebyshev I / Elliptic の場合、dB）
- 阻止帯域減衰量（Chebyshev II / Elliptic の場合、dB）
- ソースインピーダンス（Ω）
- 負荷インピーダンス（Ω）

**受け入れ条件**:
- [ ] 全パラメータに対して適切な入力バリデーションが行われる
- [ ] 近似関数に応じて必要なパラメータのみが表示される
- [ ] 入力変更時にリアルタイムで設計結果が更新される

### FR-2: フィルタ設計計算

**概要**: 入力された仕様に基づいてフィルタの伝達関数と回路定数を計算する

**処理内容**:
- 正規化ローパスプロトタイプの算出
- 周波数変換（LP→HP、LP→BP、LP→BE、LP→AP）
- インピーダンススケーリング
- 回路部品値（L、C、R）の算出

**受け入れ条件**:
- [ ] 各近似関数について正確な伝達関数が計算される
- [ ] 計算結果が既知のフィルタ設計テーブルの値と一致する
- [ ] 無効な組み合わせに対して適切なエラーメッセージが表示される

### FR-3: 特性表示

**概要**: 設計したフィルタの周波数特性をグラフで表示する

**表示内容**:
- **振幅特性**（ボード線図）: 周波数 vs ゲイン（dB）
- **位相特性**: 周波数 vs 位相（度）
- **群遅延特性**: 周波数 vs 群遅延（秒）
- **インパルス応答** （オプション）
- **ステップ応答** （オプション）

**受け入れ条件**:
- [ ] 周波数軸は対数スケールで表示される
- [ ] グラフはインタラクティブ（ズーム、パン、カーソル値表示）
- [ ] -3dBポイントがマーカーで表示される
- [ ] グラフは高解像度で描画される

### FR-4: 回路図表示

**概要**: 設計したフィルタの回路図を表示する

**表示内容**:
- ラダー型回路（T型またはπ型）の回路図
- 各部品のシンボルと値の表示
- ソース/負荷インピーダンスの表示

**受け入れ条件**:
- [ ] 回路図が正しいトポロジーで表示される
- [ ] 部品値が適切な単位（pF, nF, μF, μH, mH）で表示される
- [ ] 回路図はSVGで描画される

### FR-5: BOM（部品表）表示

**概要**: 設計したフィルタを実装するために必要な部品の一覧を表示する

**表示内容**:
- 部品番号（C1, C2, L1, L2...）
- 部品種別（コンデンサ / インダクタ / 抵抗）
- 計算値
- 数量

**受け入れ条件**:
- [ ] 全ての部品が漏れなくリストされる
- [ ] テーブル形式で表示される
- [ ] クリップボードにコピー可能（CSV形式）

## 5. 非機能要件

### NFR-1: パフォーマンス
- UIの初期表示は1秒以内（Pyodide初期化完了前でもUIは操作可能）
- Pyodide + SciPyの初期化はバックグラウンド（Web Worker）で行い、プログレスバーで進捗表示
  - 初回: 10-20秒（CDNからのダウンロード + 初期化）
  - 2回目以降: 2-5秒（ブラウザキャッシュ利用）
- 初期化完了後のフィルタ計算は入力変更後200ms以内に完了すること
- グラフの描画は500ms以内に完了すること
- UIアプリ本体のLighthouseスコア90以上を目標（Pyodideは遅延ロード）

### NFR-2: ブラウザ対応
- Chrome / Firefox / Safari / Edge の最新2バージョン
- レスポンシブデザイン（タブレット以上を推奨、モバイルは縮退表示可）

### NFR-3: ホスティング
- GitHub Pages で静的ファイルとしてホスト可能
- サーバーサイド処理は一切不要（全て クライアントサイドで完結）

### NFR-4: アクセシビリティ
- WCAG 2.1 Level AA 準拠を目標
- キーボード操作で全機能にアクセス可能

### NFR-5: 国際化
- UIは英語をデフォルト
- 将来的な多言語対応を考慮した設計

## 6. 成功指標

| 指標 | 目標値 |
|------|--------|
| 設計計算の精度 | 既知のテーブル値との誤差 ±0.1% 以内 |
| UI表示速度 | 1秒以内（計算エンジンの初期化は別途バックグラウンド） |
| サポートするフィルタ種別 | 5種別（LPF/HPF/BPF/BEF/APF）× 5近似関数 + APF = 21パターン以上 |
| ユーザー操作から結果表示まで | 1秒以内 |

## 7. 技術スタック

| カテゴリ | 技術 | 選定理由 |
|----------|------|----------|
| 言語 | TypeScript | 型安全性による設計計算の信頼性確保 |
| UIフレームワーク | React + Vite | SPAに最適、高速なHMR |
| フィルタ設計計算 | Pyodide + SciPy (Web Worker) | SciPy.signalの全近似関数を直接利用。検証済みの精度。Web Workerでメインスレッド非ブロック |
| JS-Worker通信 | Comlink | Web Workerとの型安全な非同期通信 |
| グラフ描画 | uPlot | 48KB軽量、log10ネイティブ対応、16万点を25msで描画する高性能 |
| 回路図描画 | カスタムSVG（Reactコンポーネント） | ラダー型回路の規則的構造に最適、追加依存ゼロ |
| スタイリング | Tailwind CSS | purge後 <10KB、Vite公式サポート |
| テスト | Vitest + React Testing Library | Viteネイティブ、高速 |
| ホスティング | GitHub Pages | 静的SPAに最適、無料 |
| CI/CD | GitHub Actions | GitHub Pagesとのシームレスな連携 |

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| パッシブフィルタ | 受動素子（R, L, C）のみで構成されるフィルタ回路 |
| アクティブフィルタ | 能動素子（オペアンプなど）を含むフィルタ回路 |
| 近似関数 | 理想的なフィルタ特性を近似するための数学的関数 |
| プロトタイプフィルタ | カットオフ周波数1rad/s、インピーダンス1Ωに正規化されたフィルタ |
| オールパスフィルタ | 全周波数帯域で振幅を変えず、位相のみを変化させるフィルタ。群遅延の補正や位相調整に使用 |
| ラダー型回路 | 直列素子と並列素子を交互に配置した回路構成 |
| ラティス型回路 | ブリッジ構成で実現するオールパスフィルタ回路 |
| BOM | Bill of Materials。製品を構成する部品の一覧表 |
